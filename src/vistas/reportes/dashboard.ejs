<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - CARSIL Equipos y Servicios SAC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.js.org/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #0056b3;
            --primary-dark: #003366;
            --primary-light: #e6f2ff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
            --border-radius: 12px;
            --card-radius: 16px;
            --box-shadow: 0 6px 24px rgba(0,0,0,0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-bounce: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            --text-muted: #6c757d;
            --gradient-primary: linear-gradient(135deg, #0056b3, #003366);
            --gradient-success: linear-gradient(135deg, #28a745, #20c997);
            --gradient-warning: linear-gradient(135deg, #ffc107, #fd7e14);
            --gradient-danger: linear-gradient(135deg, #dc3545, #c82333);
            --gradient-info: linear-gradient(135deg, #17a2b8, #138496);
            --gradient-purple: linear-gradient(135deg, #6f42c1, #6610f2);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 48px rgba(0,0,0,0.12);
            --shadow-hover: 0 14px 28px rgba(0,0,0,0.15), 0 10px 10px rgba(0,0,0,0.12);
            --animation-speed: 0.5s;
        }

        body { 
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e9ecef 100%);
            color: #333;
            line-height: 1.6;
        }
        
        /* Estilos de Sidebar y Main Content */
        .sidebar, .main-content { transition: var(--transition); }
        
        .toggle-sidebar-btn {
            position: absolute;
            top: 1.2rem;
            left: 290px;
            z-index: 1100;
            background: var(--gradient-primary);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,86,179,0.35);
            cursor: pointer;
            transition: var(--transition-bounce);
        }
        
        .toggle-sidebar-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(0,86,179,0.45);
        }
        
        .toggle-sidebar-btn:active {
            transform: translateY(0) scale(0.95);
        }
        
        .sidebar.hide { 
            transform: translateX(-100%); 
        }
        
        .main-content.full { 
            margin-left: 0 !important; 
        }
        
        .sidebar {
            width: 270px;
            min-height: 100vh;
            background: linear-gradient(180deg, #003366 0%, #001a33 100%);
            color: #fff;
            position: fixed;
            left: 0;
            top: 0;
            padding-top: 1rem;
            z-index: 1000;
            box-shadow: 5px 0 25px rgba(0,0,0,0.15);
        }
        
        .sidebar .sidebar-heading {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 2px;
            color: #fff;
            padding: 0.5rem 1.5rem;
        }
        
        .sidebar .company-slogan {
            font-size: 0.95rem;
            color: #b0c4de;
            font-weight: 300;
            letter-spacing: 0.5px;
        }
        
        .sidebar .menu-item {
            color: rgba(255,255,255,0.9);
            padding: 0.85rem 1.2rem;
            border-radius: 0.8rem;
            margin: 0.3rem 0.6rem;
            display: flex;
            align-items: center;
            gap: 0.9rem;
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
            position: relative;
        }
        
        .sidebar .menu-item:hover {
            background: rgba(0,86,179,0.3);
            color: #fff;
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }
        
        .sidebar .menu-item.active {
            background: linear-gradient(135deg, #0056b3, #0d6efd);
            color: #fff;
            box-shadow: 0 4px 12px rgba(0,86,179,0.4);
            font-weight: 600;
        }
        
        .sidebar .menu-item.active::before {
            content: '';
            position: absolute;
            left: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: #fff;
            border-radius: 0 4px 4px 0;
        }
        
        .sidebar .menu-item i {
            font-size: 1.2rem;
        }
        
        .sidebar .logout-item {
            color: #ff6b6b;
            margin-top: 1rem;
            border: 1px solid rgba(255,107,107,0.2);
        }
        
        .sidebar .logout-item:hover {
            background: rgba(255,107,107,0.15);
            color: #ff6b6b;
            border-color: rgba(255,107,107,0.4);
        }
        
        .main-content {
            margin-left: 270px;
            min-height: 100vh;
            padding-bottom: 2rem;
        }
        
        /* Navegación superior */
        .top-navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 15px rgba(0,0,0,0.06);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 0.75rem 0;
            position: sticky;
            top: 0;
            z-index: 900;
        }
        
        .page-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            gap: 0.7rem;
            margin-bottom: 0;
        }
        
        .page-title i {
            color: var(--primary-color);
            font-size: 1.6rem;
        }
        
        /* Dashboard tiles / cards con diseño moderno */
        .dashboard-header {
            margin-bottom: 2rem;
            position: relative;
        }
        
        .dashboard-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        
        .dashboard-subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            font-weight: 400;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px dashed rgba(0,0,0,0.07);
        }
        
        .section-title {
            font-size: 1.35rem;
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            margin-bottom: 0;
        }
        
        .section-title i {
            color: var(--primary-color);
            font-size: 1.4rem;
        }
        
        .section-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Tarjetas de Estadísticas */
        .stats-card {
            border: none;
            border-radius: var(--card-radius);
            box-shadow: var(--box-shadow);
            transition: var(--transition-bounce);
            overflow: hidden;
            position: relative;
            background: #fff;
            padding: 1.5rem;
        }
        
        .stats-card:hover {
            transform: translateY(-7px);
            box-shadow: var(--shadow-hover);
        }
        
        .stats-card.primary {
            border-left: 4px solid var(--primary-color);
        }
        
        .stats-card.success {
            border-left: 4px solid var(--success-color);
        }
        
        .stats-card.warning {
            border-left: 4px solid var(--warning-color);
        }
        
        .stats-card.danger {
            border-left: 4px solid var(--danger-color);
        }
        
        .stats-card.info {
            border-left: 4px solid var(--info-color);
        }
        
        .stats-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        
        .stats-card-title {
            font-weight: 600;
            color: var(--text-muted);
            margin: 0;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stats-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .stats-card.primary .stats-card-icon {
            background: var(--gradient-primary);
            box-shadow: 0 5px 15px rgba(0, 86, 179, 0.3);
        }
        
        .stats-card.success .stats-card-icon {
            background: var(--gradient-success);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .stats-card.warning .stats-card-icon {
            background: var(--gradient-warning);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }
        
        .stats-card.danger .stats-card-icon {
            background: var(--gradient-danger);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        .stats-card.info .stats-card-icon {
            background: var(--gradient-info);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }
        
        .stats-number {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.2;
            margin: 0;
            color: #333;
        }
        
        .stats-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .stats-trend {
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .stats-trend.up {
            color: var(--success-color);
        }
        
        .stats-trend.down {
            color: var(--danger-color);
        }
        
        /* Gráficos con diseño avanzado */
        .chart-card {
            border: none;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            background: #fff;
            overflow: hidden;
            height: 100%;
        }
        
        .chart-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            padding: 1rem;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .chart-title {
            font-weight: 600;
            color: #495057;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-size: 1.1rem;
        }
        
        .chart-title i {
            color: var(--primary-color);
        }
        
        .chart-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .chart-subtitle {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }
        
        .chart-legend {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        /* Tarjeta de alerta avanzada */
        .alert-card {
            border-radius: var(--card-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            background: white;
            position: relative;
            transition: var(--transition);
        }
        
        .alert-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .alert-card.danger {
            border-left: 4px solid var(--danger-color);
        }
        
        .alert-card.warning {
            border-left: 4px solid var(--warning-color);
        }
        
        .alert-card-body {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-card-content {
            flex: 1;
        }
        
        .alert-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .alert-card-title i {
            color: var(--danger-color);
        }
        
        .alert-card-text {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin: 0;
        }
        
        .alert-card-metric {
            font-size: 2.2rem;
            font-weight: 700;
            line-height: 1.1;
            color: var(--danger-color);
        }
        
        /* Botones modernos y elegantes */
        .btn {
            font-weight: 500;
            padding: 0.6rem 1.5rem;
            border-radius: 10px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .btn:hover::after {
            opacity: 1;
        }
        
        .btn:active {
            transform: translateY(2px);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 86, 179, 0.25);
        }
        
        .btn-primary:hover {
            box-shadow: 0 6px 15px rgba(0, 86, 179, 0.35);
            color: white;
        }
        
        .btn-outline-primary {
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            background: transparent;
            font-weight: 500;
        }
        
        .btn-outline-primary:hover {
            background: rgba(0, 86, 179, 0.07);
            color: var(--primary-dark);
        }
        
        .btn-refresh {
            background-color: rgba(0, 86, 179, 0.07);
            color: var(--primary-color);
            border: 1px solid rgba(0, 86, 179, 0.15);
            font-weight: 500;
        }
        
        .btn-refresh:hover {
            background-color: rgba(0, 86, 179, 0.12);
            color: var(--primary-dark);
        }
        
        .btn-export {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.25);
        }
        
        .btn-export:hover {
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.35);
            color: white;
        }
        
        .btn-warning {
            background: var(--gradient-warning);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.25);
        }
        
        .btn-warning:hover {
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.35);
            color: white;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        /* Panel de filtros y búsqueda sofisticado */
        .filters-panel {
            background: white;
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            padding: 1.25rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        
        .filter-group {
            flex: 1;
            min-width: 180px;
        }
        
        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .filter-control {
            width: 100%;
            padding: 0.65rem 1rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            color: #495057;
            transition: all 0.2s;
        }
        
        .filter-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 86, 179, 0.15);
        }
        
        .filters-buttons {
            display: flex;
            gap: 0.75rem;
            margin-left: auto;
        }
        
        /* Insignias (badges) elegantes */
        .badge-modern {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-weight: 500;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .badge-primary {
            background: rgba(0, 86, 179, 0.15);
            color: var(--primary-dark);
            border: 1px solid rgba(0, 86, 179, 0.2);
        }
        
        .badge-success {
            background: rgba(40, 167, 69, 0.15);
            color: #1e7e34;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }
        
        .badge-warning {
            background: rgba(255, 193, 7, 0.15);
            color: #d39e00;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .badge-danger {
            background: rgba(220, 53, 69, 0.15);
            color: #c82333;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        /* Animaciones elegantes */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .fade-in {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        .slide-in {
            animation: slideInRight 0.6s ease-out forwards;
        }
        
        .scale-in {
            animation: scaleIn 0.5s ease-out forwards;
        }
        
        /* Animaciones por sección con retardo */
        .fade-in:nth-child(1) { animation-delay: 0.1s; }
        .fade-in:nth-child(2) { animation-delay: 0.2s; }
        .fade-in:nth-child(3) { animation-delay: 0.3s; }
        .fade-in:nth-child(4) { animation-delay: 0.4s; }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #b0c4de;
            border-radius: 10px;
            border: 2px solid #f5f5f5;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        
        /* Responsive mejorado */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1050;
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .toggle-sidebar-btn {
                left: 20px;
            }
            
            .chart-container {
                height: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .container-fluid {
                padding: 1rem;
            }
            
            .stats-number {
                font-size: 1.75rem;
            }
            
            .page-title {
                font-size: 1.2rem;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .filters-row {
                flex-direction: column;
                gap: 1rem;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .filters-buttons {
                width: 100%;
                justify-content: flex-end;
                margin-top: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar Moderno Unificado -->
<nav class="sidebar" id="sidebar">
            <div class="sidebar-heading text-center py-4">
                <div class="company-name">CARSIL</div>
                <div class="company-slogan">Equipos y Servicios SAC</div>
            </div>
            <div class="d-flex flex-column h-100 px-2 py-3">
                <a href="/menu/principal" class="menu-item">
                    <i class="bi bi-house"></i>
                    Inicio
                </a>
                <a href="/proformas" class="menu-item">
                    <i class="bi bi-file-earmark-text"></i>
                    Proformas
                </a>
                <a href="/facturas" class="menu-item">
                    <i class="bi bi-receipt"></i>
                    Facturas
                
                <a href="/clientes" class="menu-item">
                    <i class="bi bi-people"></i>
                    Clientes
                </a>
                <a href="/productos" class="menu-item">
                    <i class="bi bi-box"></i>
                    Productos
                </a>
                <a href="/empleados" class="menu-item">
                    <i class="bi bi-person-badge"></i>
                    Empleados
                </a>
                <a href="/pagos" class="menu-item">
                    <i class="bi bi-cash-coin"></i>
                    Pagos
                </a>
                <a href="/reportes" class="menu-item">
                    <i class="bi bi-bar-chart"></i>
                    Reportes
                </a>
                <a href="/usuarios" class="menu-item">
                    <i class="bi bi-person-circle"></i>
                    Usuarios
                </a>
                
                <a href="/asistencia" class="menu-item">
                    <i class="bi bi-calendar-check"></i>
                    Asistencias
                </a>
                <a href="/empresa" class="menu-item">
                    <i class="bi bi-gear"></i>
                    Empresa
                </a>
                <div class="mt-auto">
                    <a href="/login" class="menu-item logout-item">
                        <i class="bi bi-box-arrow-right"></i>
                        Cerrar Sesión
                    </a>
                </div>
            </div>
        </nav>
        
        <!-- Botón para ocultar/mostrar barra -->
        <button class="toggle-sidebar-btn" id="toggleSidebarBtn" title="Ocultar/Mostrar menú">
            <i class="bi bi-list" id="toggleIcon"></i>
        </button>
        
        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <nav class="navbar navbar-expand-lg top-navbar">
                <div class="container-fluid">
                    <h5 class="page-title">
                        <i class="bi bi-bar-chart-line-fill"></i>
                        Reportes Analíticos
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-refresh btn-sm" onclick="actualizarDatos()">
                            <i class="bi bi-arrow-repeat"></i> Actualizar
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="ejecutarDiagnostico()">
                            <i class="bi bi-bug"></i> Diagnosticar VENTA
                        </button>
                        <button class="btn btn-export btn-sm" onclick="exportarPDF()">
                            <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
                        </button>
                    </div>
                </div>
            </nav>

            <div class="container-fluid py-4">
                <!-- Dashboard Header -->
                <div class="dashboard-header fade-in">
                    <div class="row align-items-center mb-4">
                        <div class="col-lg-8">
                            <div class="dashboard-title">
                                <i class="bi bi-clipboard-data text-primary"></i> Panel Analítico CARSIL
                            </div>
                            <p class="dashboard-subtitle">
                                Métricas de negocio y tendencias para toma de decisiones estratégicas
                            </p>
                        </div>
                        <div class="col-lg-4">
                            <div class="filters-panel shadow-sm">
                                <div class="filters-row">
                                    <div class="filter-group">
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                                            <select class="form-select filter-control" id="periodoFiltro">
                                                <option value="mes">Este Mes</option>
                                                <option value="trimestre">Último Trimestre</option>
                                                <option value="semestre">Último Semestre</option>
                                                <option value="anio">Este Año</option>
                                                <option value="todo" selected>Todo</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de filtros para búsqueda avanzada -->
                <div class="filters-panel mb-4 scale-in" style="display:none;" id="advanced-filters">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-funnel"></i> Filtros Avanzados</h6>
                        <button class="btn btn-sm btn-outline-secondary btn-icon" onclick="document.getElementById('advanced-filters').style.display='none'">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    <div class="filters-row">
                        <div class="filter-group">
                            <div class="filter-label">Cliente</div>
                            <select class="form-select filter-control" id="clienteFiltro">
                                <option value="">Todos los clientes</option>
                                <!-- Se llenará dinámicamente -->
                            </select>
                        </div>
                        <div class="filter-group">
                            <div class="filter-label">Estado</div>
                            <select class="form-select filter-control" id="estadoFiltro">
                                <option value="">Todos los estados</option>
                                <option value="PENDIENTE">Pendiente</option>
                                <option value="APROBADO">Aprobado</option>
                                <option value="RECHAZADO">Rechazado</option>
                                <option value="VENCIDO">Vencido</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <div class="filter-label">Rango de fechas</div>
                            <div class="d-flex gap-2">
                                <input type="date" class="form-control filter-control" id="fechaInicio">
                                <input type="date" class="form-control filter-control" id="fechaFin">
                            </div>
                        </div>
                        <div class="filters-buttons">
                            <button class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-search"></i> Filtrar
                            </button>
                            <button class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- KPIs Section - Estadísticas de Proformas -->
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-file-earmark-text"></i> Estadísticas de Proformas
                    </div>
                    <div class="section-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="document.getElementById('advanced-filters').style.display='block'">
                            <i class="bi bi-funnel"></i> Filtros
                        </button>
                    </div>
                </div>
                
                <div class="row mb-4 g-3" id="kpi-cards">
                    <div class="col-xl-3 col-lg-6 col-md-6">
                        <div class="stats-card primary fade-in">
                            <div class="stats-card-header">
                                <div class="stats-card-title">Total Proformas</div>
                                <div class="stats-card-icon">
                                    <i class="bi bi-file-earmark-text"></i>
                                </div>
                            </div>
                            <div class="stats-number" id="total-proformas">0</div>
                            <div class="stats-label">
                                <span>Documentos generados</span>
                                <div class="stats-trend up ms-2">
                                    <i class="bi bi-arrow-up-right"></i> 8%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-lg-6 col-md-6">
                        <div class="stats-card success fade-in">
                            <div class="stats-card-header">
                                <div class="stats-card-title">Valor Promedio</div>
                                <div class="stats-card-icon">
                                    <i class="bi bi-currency-dollar"></i>
                                </div>
                            </div>
                            <div class="stats-number" id="promedio-proformas">S/ 0.00</div>
                            <div class="stats-label">
                                <span>Promedio por proforma</span>
                                <div class="stats-trend up ms-2">
                                    <i class="bi bi-arrow-up-right"></i> 5%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-lg-6 col-md-6">
                        <div class="stats-card info fade-in">
                            <div class="stats-card-header">
                                <div class="stats-card-title">Tasa Conversión</div>
                                <div class="stats-card-icon">
                                    <i class="bi bi-percent"></i>
                                </div>
                            </div>
                            <div class="stats-number" id="tasa-conversion">0%</div>
                            <div class="stats-label">
                                <span>Proformas a ventas</span>
                                <div class="stats-trend down ms-2">
                                    <i class="bi bi-arrow-down-right"></i> 2%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-lg-6 col-md-6">
                        <div class="stats-card warning fade-in">
                            <div class="stats-card-header">
                                <div class="stats-card-title">Pendientes</div>
                                <div class="stats-card-icon">
                                    <i class="bi bi-clock"></i>
                                </div>
                            </div>
                            <div class="stats-number" id="proformas-pendientes">0</div>
                            <div class="stats-label">
                                <span>Esperando aprobación</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- KPIs Section - Proformas Vencidas/No Vendidas -->
                <div class="row mb-5 g-3 fade-in" id="kpi-proformas-vencidas">
                    <div class="col-12">
                        <div class="alert-card danger">
                            <div class="alert-card-body">
                                <div class="alert-card-content">
                                    <div class="alert-card-title">
                                        <i class="bi bi-exclamation-triangle-fill"></i>
                                        Proformas Vencidas (No Vendidas)
                                    </div>
                                    <p class="alert-card-text">
                                        Proformas que superaron su período de validez y no se convirtieron en ventas.
                                        <a href="/proformas" class="text-decoration-none">Ver detalles</a>
                                    </p>
                                </div>
                                <div class="alert-card-metric" id="proformas-vencidas">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos de Proformas -->
                <div class="row g-4 mb-5">
                    <div class="col-lg-8">
                        <div class="chart-card fade-in">
                            <div class="chart-header">
                                <div>
                                    <h5 class="chart-title">
                                        <i class="bi bi-graph-up"></i> Proformas Generadas por Mes
                                    </h5>
                                    <div class="chart-subtitle">Evolución mensual de proformas emitidas</div>
                                </div>
                                <div class="chart-actions">
                                    <button class="btn btn-sm btn-outline-primary btn-icon" title="Descargar" onclick="exportarGraficoIndividual('chartProformasMes', 'Proformas_Mensuales')">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartProformasMes"></canvas>
                            </div>
                            <div class="chart-legend px-3 pb-2">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #0056b3;"></div>
                                    <span>Cantidad de Proformas</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #28a745;"></div>
                                    <span>Total Ventas (S/)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="chart-card fade-in">
                            <div class="chart-header">
                                <div>
                                    <h5 class="chart-title">
                                        <i class="bi bi-pie-chart-fill"></i> Estados de Proformas
                                    </h5>
                                    <div class="chart-subtitle">Distribución por estado actual</div>
                                </div>
                                <div class="chart-actions">
                                    <button class="btn btn-sm btn-outline-primary btn-icon" title="Descargar" onclick="exportarGraficoIndividual('chartEstados', 'Estados_Proformas')">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartEstados"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-5">
                    <div class="col-lg-8">
                        <div class="chart-card fade-in">
                            <div class="chart-header">
                                <div>
                                    <h5 class="chart-title">
                                        <i class="bi bi-bar-chart-fill"></i> Top 10 Clientes por Proformas
                                    </h5>
                                    <div class="chart-subtitle">Clientes con mayor número de proformas generadas</div>
                                </div>
                                <div class="chart-actions">
                                    <button class="btn btn-sm btn-outline-primary btn-icon" title="Descargar" onclick="exportarGraficoIndividual('chartTopClientes', 'Top_Clientes')">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartTopClientes"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="chart-card fade-in">
                            <div class="chart-header">
                                <div>
                                    <h5 class="chart-title">
                                        <i class="bi bi-people-fill"></i> Distribución por Cliente
                                    </h5>
                                    <div class="chart-subtitle">Participación de mercado por cliente</div>
                                </div>
                                <div class="chart-actions">
                                    <button class="btn btn-sm btn-outline-primary btn-icon" title="Descargar" onclick="exportarGraficoIndividual('chartDistribucionClientes', 'Distribucion_Clientes')">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartDistribucionClientes"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- KPIs Section - Estadísticas de Ventas -->
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-cash-stack"></i> Estadísticas de Ventas
                    </div>
                    <div class="section-actions">
                        <div class="badge-modern badge-primary">
                            <i class="bi bi-calendar-event"></i> Mes actual
                        </div>
                    </div>
                </div>
                
                <div class="row mb-5 g-3" id="kpi-ventas">
                    <div class="col-xl-4 col-lg-6 col-md-6">
                        <div class="stats-card danger fade-in">
                            <div class="stats-card-header">
                                <div class="stats-card-title">Ventas del Mes</div>
                                <div class="stats-card-icon">
                                    <i class="bi bi-cash-stack"></i>
                                </div>
                            </div>
                            <div class="stats-number" id="ventas-mes">S/ 0.00</div>
                            <div class="stats-label">
                                <span>Ingresos mensuales</span>
                                <div class="stats-trend up ms-2">
                                    <i class="bi bi-arrow-up-right"></i> 12%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-lg-6 col-md-6">
                        <div class="stats-card success fade-in">
                            <div class="stats-card-header">
                                <div class="stats-card-title">Ventas Completadas</div>
                                <div class="stats-card-icon">
                                    <i class="bi bi-check-circle"></i>
                                </div>
                            </div>
                            <div class="stats-number" id="ventas-completadas">0</div>
                            <div class="stats-label">
                                <span>Transacciones finalizadas</span>
                                <div class="stats-trend up ms-2">
                                    <i class="bi bi-arrow-up-right"></i> 3%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-4 col-lg-6 col-md-6">
                        <div class="stats-card info fade-in">
                            <div class="stats-card-header">
                                <div class="stats-card-title">Eficiencia de Ventas</div>
                                <div class="stats-card-icon">
                                    <i class="bi bi-graph-up-arrow"></i>
                                </div>
                            </div>
                            <div class="stats-number" id="eficiencia-ventas">0%</div>
                            <div class="stats-label">
                                <span>% de ventas exitosas</span>
                                <div class="stats-trend down ms-2">
                                    <i class="bi bi-arrow-down-right"></i> 1%
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gráficos de Ventas -->
                <div class="row g-4 mb-5">
                    <div class="col-lg-8">
                        <div class="chart-card fade-in">
                            <div class="chart-header">
                                <div>
                                    <h5 class="chart-title">
                                        <i class="bi bi-graph-up"></i> Ventas Mensuales
                                    </h5>
                                    <div class="chart-subtitle">Evolución de ventas a través del tiempo</div>
                                </div>
                                <div class="chart-actions">
                                    <button class="btn btn-sm btn-outline-primary btn-icon" title="Descargar" onclick="exportarGraficoIndividual('chartVentasMes', 'Ventas_Mensuales')">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartVentasMes"></canvas>
                            </div>
                            <div class="chart-legend px-3 pb-2">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #dc3545;"></div>
                                    <span>Cantidad de Ventas</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #198754;"></div>
                                    <span>Total Ventas (S/)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="chart-card fade-in">
                            <div class="chart-header">
                                <div>
                                    <h5 class="chart-title">
                                        <i class="bi bi-trophy-fill"></i> Top 5 Clientes por Ventas
                                    </h5>
                                    <div class="chart-subtitle">Clientes con mayor volumen de compras</div>
                                </div>
                                <div class="chart-actions">
                                    <button class="btn btn-sm btn-outline-primary btn-icon" title="Descargar" onclick="exportarGraficoIndividual('chartTopClientesVentas', 'Top_Clientes_Ventas')">
                                        <i class="bi bi-download"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chartTopClientesVentas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Panel de Estrategias -->
                <div class="section-header">
                    <div class="section-title">
                        <i class="bi bi-lightning-charge"></i> Acciones Recomendadas
                    </div>
                </div>
                
                <div class="row g-4 mb-4">
                    <div class="col-lg-12">
                        <div class="card fade-in" style="border-radius: var(--card-radius); overflow: hidden; box-shadow: var(--shadow-md);">
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead style="background: linear-gradient(135deg, #f8f9fa, #e9ecef);">
                                            <tr>
                                                <th scope="col" style="padding: 1rem 1.5rem;">#</th>
                                                <th scope="col" style="padding: 1rem 1.5rem;">Acción recomendada</th>
                                                <th scope="col" style="padding: 1rem 1.5rem;">Impacto</th>
                                                <th scope="col" style="padding: 1rem 1.5rem;">Prioridad</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td style="padding: 1rem 1.5rem;">1</td>
                                                <td style="padding: 1rem 1.5rem;">
                                                    <div class="d-flex align-items-center">
                                                        <div style="width: 32px; height: 32px; background: var(--gradient-danger); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                                                            <i class="bi bi-telephone"></i>
                                                        </div>
                                                        <div>
                                                            <strong>Contactar clientes con proformas vencidas</strong>
                                                            <div class="text-muted small" id="clientesConProformasVencidas">Clientes con proformas próximas a vencer</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td style="padding: 1rem 1.5rem;"><span class="badge bg-danger">Alto</span></td>
                                                <td style="padding: 1rem 1.5rem;"><i class="bi bi-exclamation-triangle text-danger"></i> Urgente</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 1rem 1.5rem;">2</td>
                                                <td style="padding: 1rem 1.5rem;">
                                                    <div class="d-flex align-items-center">
                                                        <div style="width: 32px; height: 32px; background: var(--gradient-primary); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                                                            <i class="bi bi-arrow-repeat"></i>
                                                        </div>
                                                        <div>
                                                            <strong>Seguimiento de proformas pendientes</strong>
                                                            <div class="text-muted small" id="seguimientoProformasPendientes">Aumentar tasa de conversión</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td style="padding: 1rem 1.5rem;"><span class="badge bg-primary">Medio</span></td>
                                                <td style="padding: 1rem 1.5rem;"><i class="bi bi-clock text-primary"></i> Esta semana</td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 1rem 1.5rem;">3</td>
                                                <td style="padding: 1rem 1.5rem;">
                                                    <div class="d-flex align-items-center">
                                                        <div style="width: 32px; height: 32px; background: var(--gradient-success); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-right: 10px;">
                                                            <i class="bi bi-graph-up-arrow"></i>
                                                        </div>
                                                        <div>
                                                            <strong>Revisar estrategia de ventas para clientes principales</strong>
                                                            <div class="text-muted small">Enfoque en top 5 clientes</div>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td style="padding: 1rem 1.5rem;"><span class="badge bg-success">Alto</span></td>
                                                <td style="padding: 1rem 1.5rem;"><i class="bi bi-calendar3 text-success"></i> Este mes</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer del dashboard -->
                <div class="mt-5 text-center text-muted small fade-in">
                    <p>
                        Última actualización: <span id="ultima-actualizacion"><%= new Date().toLocaleString('es-ES') %></span> | 
                        <a href="#" onclick="actualizarDatos(); return false;" class="text-decoration-none">
                            <i class="bi bi-arrow-repeat"></i> Actualizar datos
                        </a>
                    </p>
                    <p>
                        CARSIL Equipos y Servicios SAC © <%= new Date().getFullYear() %> | Panel de Reportes v1.0
                    </p>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Variables globales para los gráficos
        let chartProformasMes, chartEstados, chartTopClientes, chartDistribucionClientes, chartVentasMes, chartTopClientesVentas;

        // Inicializar dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar sidebar
            const toggleBtn = document.getElementById('toggleSidebarBtn');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            
            toggleBtn.addEventListener('click', function() {
                sidebar.classList.toggle('hide');
                mainContent.classList.toggle('full');
            });

            // Cargar datos iniciales
            cargarKPIs();
            cargarGraficos();
        });

        // Cargar KPIs separando proformas de ventas
        async function cargarKPIs() {
            try {
                console.log('Cargando KPIs separados de proformas y ventas...');
                
                // Mostrar estado de carga para proformas
                document.querySelectorAll('#kpi-cards .stats-number').forEach(el => {
                    el.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
                });
                
                // Mostrar estado de carga para ventas
                document.querySelectorAll('#kpi-ventas .stats-number').forEach(el => {
                    el.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
                });
                
                // Mostrar estado de carga para proformas vencidas
                document.getElementById('proformas-vencidas').innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';

                const response = await fetch('/reportes/api/kpis');
                const data = await response.json();
                console.log('Datos de KPIs recibidos:', data);
                
                if (data.success) {
                    // === KPIs DE PROFORMAS (posibles ventas) ===
                    document.getElementById('total-proformas').textContent = data.data.totalProformas || 0;
                    document.getElementById('promedio-proformas').textContent = 'S/ ' + (data.data.promedioProformas || 0).toLocaleString('es-PE');
                    document.getElementById('tasa-conversion').textContent = (data.data.tasaConversion || 0) + '%';
                    document.getElementById('proformas-pendientes').textContent = data.data.proformasPendientes || 0;
                    document.getElementById('proformas-vencidas').textContent = data.data.proformasVencidas || 0;
                    
                    // === KPIs DE VENTAS REALES ===
                    document.getElementById('ventas-mes').textContent = 'S/ ' + (data.data.ventasMes || 0).toLocaleString('es-PE');
                    document.getElementById('ventas-completadas').textContent = data.data.ventasCompletadas || 0;
                    
                    // Calcular eficiencia (% de ventas completadas vs total ventas)
                    const totalVentas = data.data.totalVentas || 0;
                    const ventasCompletadas = data.data.ventasCompletadas || 0;
                    const eficiencia = totalVentas > 0 ? 
                        ((ventasCompletadas / totalVentas) * 100).toFixed(2) : 0;
                    document.getElementById('eficiencia-ventas').textContent = eficiencia + '%';
                    
                    console.log('KPIs actualizados:', {
                        proformas: {
                            total: data.data.totalProformas,
                            pendientes: data.data.proformasPendientes,
                            vencidas: data.data.proformasVencidas,
                            promedio: data.data.promedioProformas
                        },
                        ventas: {
                            total: data.data.totalVentas,
                            completadas: data.data.ventasCompletadas,
                            delMes: data.data.ventasMes,
                            eficiencia: eficiencia
                        },
                        conversion: data.data.tasaConversion
                    });
                    
                    // Mostrar información adicional en consola
                    if (data.data.proformasVencidas > 0) {
                        console.warn(`Se encontraron ${data.data.proformasVencidas} proformas vencidas`);
                    }
                } else {
                    console.error('Error en respuesta de KPIs:', data.message);
                    throw new Error(data.message || 'Error al cargar KPIs');
                }
            } catch (error) {
                console.error('Error al cargar KPIs:', error);
                document.querySelectorAll('#kpi-cards .stats-number, #kpi-ventas .stats-number').forEach(el => {
                    el.textContent = 'Error';
                });
            }
        }

        // Cargar todos los gráficos
        async function cargarGraficos() {
            await Promise.all([
                cargarGraficoProformasMes(),
                cargarGraficoEstados(),
                cargarGraficoTopClientes(),
                cargarGraficoDistribucionClientes(),
                cargarGraficoVentasMes(),
                cargarGraficoTopClientesVentas()
            ]);
        }

        // Gráfico de líneas: Proformas por mes
        async function cargarGraficoProformasMes() {
            try {
                const response = await fetch('/reportes/api/proformas-por-mes');
                const data = await response.json();
                
                if (data.success) {
                    const ctx = document.getElementById('chartProformasMes').getContext('2d');
                    
                    if (chartProformasMes) {
                        chartProformasMes.destroy();
                    }
                    
                    chartProformasMes = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.data.map(item => {
                                const [year, month] = item.mes.split('-');
                                return new Date(year, month - 1).toLocaleDateString('es-ES', { 
                                    month: 'short', 
                                    year: 'numeric' 
                                });
                            }),
                            datasets: [{
                                label: 'Cantidad de Proformas',
                                data: data.data.map(item => item.cantidad),
                                borderColor: '#0056b3',
                                backgroundColor: 'rgba(0, 86, 179, 0.1)',
                                tension: 0.3,
                                yAxisID: 'y',
                                borderWidth: 2,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#0056b3',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }, {
                                label: 'Total Ventas (S/)',
                                data: data.data.map(item => item.total_ventas),
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                                tension: 0.3,
                                yAxisID: 'y1',
                                borderWidth: 2,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#28a745',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    padding: 12,
                                    cornerRadius: 6
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Cantidad',
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Ventas (S/)',
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error al cargar gráfico de proformas por mes:', error);
            }
        }

        // Gráfico circular: Estados de proformas
        async function cargarGraficoEstados() {
            try {
                const response = await fetch('/reportes/api/proformas-por-estado');
                const data = await response.json();
                
                if (data.success) {
                    const ctx = document.getElementById('chartEstados').getContext('2d');
                    
                    if (chartEstados) {
                        chartEstados.destroy();
                    }
                    
                    const colores = ['#0056b3', '#28a745', '#ffc107', '#dc3545', '#6c757d'];
                    
                    chartEstados = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.data.map(item => item.Estado),
                            datasets: [{
                                data: data.data.map(item => item.cantidad),
                                backgroundColor: colores.slice(0, data.data.length),
                                borderWidth: 0,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '70%',
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        font: {
                                            size: 11
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    padding: 12,
                                    cornerRadius: 6,
                                    callbacks: {
                                        label: function(context) {
                                            const item = data.data[context.dataIndex];
                                            return `${item.Estado}: ${item.cantidad} (${item.porcentaje}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error al cargar gráfico de estados:', error);
            }
        }

        // Gráfico de barras: Top clientes
        async function cargarGraficoTopClientes() {
            try {
                const response = await fetch('/reportes/api/top-clientes');
                const data = await response.json();
                
                if (data.success) {
                    const ctx = document.getElementById('chartTopClientes').getContext('2d');
                    
                    if (chartTopClientes) {
                        chartTopClientes.destroy();
                    }
                    
                    chartTopClientes = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.data.map(item => item.RazonSocial.length > 20 ? 
                                item.RazonSocial.substring(0, 20) + '...' : 
                                item.RazonSocial
                            ),
                            datasets: [{
                                label: 'Número de Proformas',
                                data: data.data.map(item => item.total_proformas),
                                backgroundColor: 'rgba(0, 86, 179, 0.8)',
                                borderColor: 'rgba(0, 86, 179, 1)',
                                borderWidth: 0,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Cantidad de Proformas',
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    padding: 12,
                                    cornerRadius: 6,
                                    callbacks: {
                                        afterLabel: function(context) {
                                            const item = data.data[context.dataIndex];
                                            return [
                                                `Total Ventas: S/ ${item.total_ventas.toLocaleString('es-PE')}`,
                                                `Promedio: S/ ${item.promedio_venta.toLocaleString('es-PE')}`
                                            ];
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error al cargar gráfico de top clientes:', error);
            }
        }

        // Gráfico circular: Distribución por cliente
        async function cargarGraficoDistribucionClientes() {
            try {
                const response = await fetch('/reportes/api/proformas-por-cliente');
                const data = await response.json();
                
                if (data.success) {
                    const ctx = document.getElementById('chartDistribucionClientes').getContext('2d');
                    
                    if (chartDistribucionClientes) {
                        chartDistribucionClientes.destroy();
                    }
                    
                    const colores = [
                        '#0056b3', '#28a745', '#ffc107', '#dc3545', 
                        '#6c757d', '#17a2b8', '#6610f2', '#fd7e14'
                    ];
                    
                    chartDistribucionClientes = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: data.data.map(item => 
                                item.cliente.length > 15 ? 
                                item.cliente.substring(0, 15) + '...' : 
                                item.cliente
                            ),
                            datasets: [{
                                data: data.data.map(item => item.cantidad),
                                backgroundColor: colores.slice(0, data.data.length),
                                borderWidth: 0,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        boxWidth: 12,
                                        font: {
                                            size: 10
                                        },
                                        padding: 16,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    padding: 12,
                                    cornerRadius: 6,
                                    callbacks: {
                                        label: function(context) {
                                            const item = data.data[context.dataIndex];
                                            return `${item.cliente}: ${item.cantidad} proformas`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error al cargar gráfico de distribución por clientes:', error);
            }
        }

        // Función para actualizar todos los datos
        function actualizarDatos() {
            // Mostrar indicador de carga
            const btnRefresh = document.querySelector('.btn-refresh');
            const originalContent = btnRefresh.innerHTML;
            btnRefresh.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Actualizando...';
            
            // Deshabilitar botón temporalmente
            btnRefresh.disabled = true;
            
            // Recargar datos
            cargarKPIs();
            cargarGraficos().finally(() => {
                // Restaurar botón
                setTimeout(() => {
                    btnRefresh.innerHTML = originalContent;
                    btnRefresh.disabled = false;
                }, 500);
            });
        }

        // Gráfico de líneas: Ventas por mes
        async function cargarGraficoVentasMes() {
            try {
                console.log('Cargando datos de ventas por mes...');
                console.log('Fecha y hora actual:', new Date().toLocaleString());
                
                // Mostrar mensaje de carga en el gráfico
                const ctx = document.getElementById('chartVentasMes').getContext('2d');
                if (chartVentasMes) {
                    chartVentasMes.destroy();
                }
                
                // Crear un mensaje temporal mientras se cargan los datos
                const tempChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Cargando...'],
                        datasets: [{
                            label: 'Cargando datos',
                            data: [0],
                            backgroundColor: 'rgba(200, 200, 200, 0.5)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        plugins: {
                            title: {
                                display: true,
                                text: 'Cargando datos de ventas...',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                // Hacer la solicitud de datos
                const response = await fetch('/reportes/api/ventas-por-mes');
                const data = await response.json();
                console.log('Datos de ventas recibidos:', data);
                console.log('¿Se recibieron datos correctamente?', data.success ? 'SÍ' : 'NO');
                console.log('Cantidad de registros recibidos:', data.data ? data.data.length : 0);
                console.log('Datos completos:', JSON.stringify(data.data || [], null, 2));
                
                // Eliminar el gráfico temporal
                tempChart.destroy();
                
                if (data.success) {
                    if (!data.data || data.data.length === 0) {
                        console.warn('Se recibió una respuesta exitosa pero sin datos');
                    }
                    
                    // Procesar los datos para el gráfico
                    const labels = data.data.map(item => {
                        console.log('Procesando mes:', item.mes);
                        const [year, month] = item.mes.split('-');
                        return new Date(year, month - 1).toLocaleDateString('es-ES', { 
                            month: 'short', 
                            year: 'numeric' 
                        });
                    });
                    
                    const cantidades = data.data.map(item => {
                        console.log(`Cantidad para ${item.mes}:`, item.cantidad);
                        return item.cantidad;
                    });
                    
                    const totales = data.data.map(item => {
                        console.log(`Total ventas para ${item.mes}:`, item.total_ventas);
                        return item.total_ventas;
                    });
                    
                    console.log('Labels procesados:', labels);
                    console.log('Cantidades procesadas:', cantidades);
                    console.log('Totales procesados:', totales);
                    
                    // Crear el gráfico final
                    chartVentasMes = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Cantidad de Ventas',
                                data: cantidades,
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                tension: 0.3,
                                yAxisID: 'y',
                                borderWidth: 2,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#dc3545',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }, {
                                label: 'Total Ventas (S/)',
                                data: totales,
                                borderColor: '#198754',
                                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                tension: 0.3,
                                yAxisID: 'y1',
                                borderWidth: 2,
                                pointBackgroundColor: '#fff',
                                pointBorderColor: '#198754',
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 20
                                    }
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    padding: 12,
                                    cornerRadius: 6
                                }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Cantidad',
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.05)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Ventas (S/)',
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        drawOnChartArea: false,
                                    },
                                },
                                x: {
                                    grid: {
                                        display: false
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error al cargar gráfico de ventas por mes:', error);
            }
        }

        // Gráfico de barras: Top clientes con ventas
        async function cargarGraficoTopClientesVentas() {
            try {
                const response = await fetch('/reportes/api/top-clientes-ventas');
                const data = await response.json();
                
                if (data.success) {
                    const ctx = document.getElementById('chartTopClientesVentas').getContext('2d');
                    
                    if (chartTopClientesVentas) {
                        chartTopClientesVentas.destroy();
                    }
                    
                    chartTopClientesVentas = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.data.map(item => item.RazonSocial.length > 15 ? 
                                item.RazonSocial.substring(0, 15) + '...' : 
                                item.RazonSocial
                            ),
                            datasets: [{
                                label: 'Total Ventas (S/)',
                                data: data.data.map(item => item.total_monto),
                                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                                borderColor: 'rgba(220, 53, 69, 1)',
                                borderWidth: 0,
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Monto (S/)',
                                        font: {
                                            weight: 'bold'
                                        }
                                    },
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 14,
                                        weight: 'bold'
                                    },
                                    bodyFont: {
                                        size: 12
                                    },
                                    padding: 12,
                                    cornerRadius: 6,
                                    callbacks: {
                                        afterLabel: function(context) {
                                            const item = data.data[context.dataIndex];
                                            return [
                                                `Cantidad: ${item.total_ventas}`,
                                                `Promedio: S/ ${item.promedio_venta.toLocaleString('es-PE')}`
                                            ];
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error al cargar gráfico de top clientes por ventas:', error);
            }
        }

        // Función para exportar a PDF
        async function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const btnExport = document.querySelector('.btn-export');
            const originalContent = btnExport.innerHTML;
            
            try {
                // Mostrar estado de carga
                btnExport.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Generando PDF...';
                btnExport.disabled = true;
                
                // Crear el PDF
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 15;
                let yPosition = margin;
                
                // Título del reporte
                pdf.setFontSize(20);
                pdf.setTextColor(0, 86, 179);
                pdf.text('CARSIL - Reporte Analítico', margin, yPosition);
                yPosition += 10;
                
                pdf.setFontSize(12);
                pdf.setTextColor(100, 100, 100);
                const fechaActual = new Date().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                pdf.text(`Fecha de generación: ${fechaActual}`, margin, yPosition);
                yPosition += 20;
                
                // KPIs Section
                pdf.setFontSize(16);
                pdf.setTextColor(44, 62, 80);
                pdf.text('Indicadores Clave (KPIs)', margin, yPosition);
                yPosition += 15;
                
                // Obtener valores de KPIs
                const totalProformas = document.getElementById('total-proformas').textContent;
                const promedioProformas = document.getElementById('promedio-proformas').textContent;
                const tasaConversion = document.getElementById('tasa-conversion').textContent;
                const proformasPendientes = document.getElementById('proformas-pendientes').textContent;
                
                pdf.setFontSize(11);
                pdf.setTextColor(60, 60, 60);
                const kpiData = [
                    ['Total de Proformas:', totalProformas],
                    ['Valor Promedio:', promedioProformas],
                    ['Tasa de Conversión:', tasaConversion],
                    ['Proformas Pendientes:', proformasPendientes]
                ];
                
                kpiData.forEach(([label, value]) => {
                    pdf.text(label, margin, yPosition);
                    pdf.setFont(undefined, 'bold');
                    pdf.text(value, margin + 50, yPosition);
                    pdf.setFont(undefined, 'normal');
                    yPosition += 8;
                });
                
                yPosition += 15;
                
                // Función para capturar y agregar gráfico
                async function agregarGrafico(canvasId, titulo, targetWidth = 160, targetHeight = 100) {
                    if (yPosition + targetHeight + 20 > pageHeight - margin) {
                        pdf.addPage();
                        yPosition = margin;
                    }
                    
                    const canvas = document.getElementById(canvasId);
                    if (canvas) {
                        try {
                            // Título del gráfico
                            pdf.setFontSize(14);
                            pdf.setTextColor(44, 62, 80);
                            pdf.text(titulo, margin, yPosition);
                            yPosition += 10;
                            
                            // Capturar el canvas del gráfico
                            const imgData = canvas.toDataURL('image/png', 1.0);
                            
                            // Agregar imagen al PDF
                            pdf.addImage(imgData, 'PNG', margin, yPosition, targetWidth, targetHeight);
                            yPosition += targetHeight + 15;
                            
                        } catch (error) {
                            console.error(`Error al capturar gráfico ${canvasId}:`, error);
                            pdf.setFontSize(10);
                            pdf.setTextColor(220, 53, 69);
                            pdf.text(`Error al cargar gráfico: ${titulo}`, margin, yPosition);
                            yPosition += 15;
                        }
                    }
                }
                
                // Agregar gráficos
                await agregarGrafico('chartProformasMes', 'Proformas Generadas por Mes', 160, 100);
                await agregarGrafico('chartEstados', 'Estados de Proformas', 80, 80);
                
                // Nueva página para los otros gráficos
                if (yPosition > pageHeight / 2) {
                    pdf.addPage();
                    yPosition = margin;
                }
                
                await agregarGrafico('chartTopClientes', 'Top 10 Clientes por Proformas', 160, 100);
                await agregarGrafico('chartDistribucionClientes', 'Distribución por Cliente', 80, 80);
                
                // Agregar gráficos de ventas
                await agregarGrafico('chartVentasMes', 'Ventas Mensuales', 160, 100);
                await agregarGrafico('chartTopClientesVentas', 'Top 5 Clientes por Ventas', 80, 100);
                
                // Footer
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setTextColor(150, 150, 150);
                    pdf.text(`Página ${i} de ${totalPages}`, pageWidth - margin - 20, pageHeight - 10);
                    pdf.text('CARSIL Equipos y Servicios SAC', margin, pageHeight - 10);
                }
                
                // Descargar el PDF
                pdf.save(`Reporte_Analitico_${new Date().toISOString().split('T')[0]}.pdf`);
                
                // Mostrar éxito
                btnExport.innerHTML = '<i class="bi bi-check-circle"></i> PDF Generado';
                setTimeout(() => {
                    btnExport.innerHTML = originalContent;
                    btnExport.disabled = false;
                }, 3000);
                
            } catch (error) {
                console.error('Error al generar PDF:', error);
                btnExport.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error';
                setTimeout(() => {
                    btnExport.innerHTML = originalContent;
                    btnExport.disabled = false;
                }, 3000);
                
                alert('Error al generar el PDF. Por favor, intente nuevamente.');
            }
        }

        // Función para ejecutar diagnóstico de la tabla VENTA
        async function ejecutarDiagnostico() {
            try {
                // Mostrar indicador de carga en el botón
                const btnDiagnostico = document.querySelector('.btn-warning');
                const originalContent = btnDiagnostico.innerHTML;
                btnDiagnostico.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Diagnosticando...';
                btnDiagnostico.disabled = true;
                
                console.log('Iniciando diagnóstico de la tabla VENTA...');
                const response = await fetch('/reportes/api/diagnostico-venta');
                const data = await response.json();
                
                if (data.success) {
                    console.log('=== RESULTADO DE DIAGNÓSTICO ===');
                    console.log('Tabla VENTA existe:', data.diagnostico.tablaExiste ? 'SÍ' : 'NO');
                    console.log('Estructura de la tabla:', data.diagnostico.estructura);
                    console.log('Triggers en FACTURA:', data.diagnostico.triggers);
                    console.log('Total registros en VENTA:', data.diagnostico.totalRegistros);
                    console.log('Total de facturas:', data.diagnostico.totalFacturas);
                    console.log('Facturas sin registro en VENTA:', data.diagnostico.facturasSinVenta);
                    console.log('Distribución por meses:', data.diagnostico.distribucionMeses);
                    console.log('Ventas por cliente:', data.diagnostico.ventasPorCliente);
                    
                    if (data.diagnostico.muestraVentas) {
                        console.log('Muestra de registros en VENTA:', data.diagnostico.muestraVentas);
                    }
                    
                    // Mostrar un modal o alerta con resultados básicos
                    alert(`Diagnóstico completado (ver consola para detalles completos)
                    
Total registros en VENTA: ${data.diagnostico.totalRegistros}
Total facturas: ${data.diagnostico.totalFacturas}
Facturas sin registro en VENTA: ${data.diagnostico.facturasSinVenta}
Triggers instalados: ${data.diagnostico.triggers.length}

${data.diagnostico.facturasSinVenta > 0 ? 
'ACCIÓN REQUERIDA: Hay facturas sin registro en VENTA. Usa el script instalar_triggers_venta.js para corregir.' : 
'Sincronización VENTA-FACTURA correcta.'}

Fecha diagnóstico: ${new Date(data.diagnostico.fechaHoraDiagnostico).toLocaleString()}`);
                    
                    // Si hay problemas, sugerir soluciones
                    if (data.diagnostico.facturasSinVenta > 0 || !data.diagnostico.tablaExiste || data.diagnostico.triggers.length < 2) {
                        console.warn('=== PROBLEMAS DETECTADOS ===');
                        console.warn('Se recomienda ejecutar el script src/bd/instalar_triggers_venta.js para corregir los problemas');
                        console.warn('Ejecuta: node src/bd/instalar_triggers_venta.js');
                    } else {
                        console.log('No se detectaron problemas graves en la configuración de VENTA');
                    }
                    
                    // Si el diagnóstico muestra problemas, ofrecer actualizar los datos
                    if (data.diagnostico.facturasSinVenta > 0) {
                        if (confirm('Se encontraron facturas sin registro en VENTA. ¿Desea actualizar los datos ahora?')) {
                            actualizarDatos();
                        }
                    }
                } else {
                    console.error('Error en diagnóstico:', data.message);
                    alert('Error al realizar diagnóstico: ' + data.message);
                }
            } catch (error) {
                console.error('Error al ejecutar diagnóstico:', error);
                alert('Error al ejecutar diagnóstico: ' + error.message);
            } finally {
                // Restaurar botón
                const btnDiagnostico = document.querySelector('.btn-warning');
                btnDiagnostico.innerHTML = '<i class="bi bi-bug"></i> Diagnosticar VENTA';
                btnDiagnostico.disabled = false;
            }
        }

        // Función para redirigir a la lista de proformas
        function mostrarProformasVencidas() {
            // Redirigir a la página de proformas
            window.location.href = '/proformas';
        }
        
    </script>
</body>
</html>
